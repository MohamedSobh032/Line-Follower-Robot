/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2024 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 ******************************************************************************
 */

#include "LSTD_TYPES.h"
#include "LBIT_MATH.h"
#include "MNVIC_Interface.h"
#include "MSTK_Interface.h"
#include "MRCC_Interface.h"
#include "MGPIO_Interface.h"
#include "MUSART_Interface.h"
#include "MADC_Interface.h"
#include "MDMA_Interface.h"


u16 APP_u16IRData[2];

void APP_vInit(void) {
	/* INIT CLOCK AND PERIPHERALS CLOCK */
	MRCC_vInitSysAndBusClock();
	MRCC_vEnablePeriphClock(MRCC_BUS_AHB1, MRCC_AHB1_GPIOAEN);
	MRCC_vEnablePeriphClock(MRCC_BUS_APB2, MRCC_APB2_ADC1EN);
	MRCC_vEnablePeriphClock(MRCC_BUS_AHB1, MRCC_AHB1_DMA2EN);
	/* INIT ALL NEEDED PINS */
	MGPIO_vSetPinMode(GPIOA, MGPIO_PIN00, MGPIO_MODE_ANALOG);
	MGPIO_vSetPinMode(GPIOA, MGPIO_PIN01, MGPIO_MODE_ANALOG);
	/* INIT ADC SETTINGS */
	MADC_vInit();
	MADC_vSetNumberOfConversions(MADC_REGULAR_GROUP, MADC_TWO_CONVERSIONS);
	MADC_vSetSamplingTime(MADC_CHANNEL0, MADC_SAMPLING_CYCLES_3);
	MADC_vSetSamplingTime(MADC_CHANNEL1, MADC_SAMPLING_CYCLES_3);
	MADC_vSetSequence(MADC_REGULAR_GROUP, MADC_CHANNEL0, MADC_SEQUENCE_1);
	MADC_vSetSequence(MADC_REGULAR_GROUP, MADC_CHANNEL1, MADC_SEQUENCE_2);

	volatile u32* DMAsrcAddr = MADC_vSetRegularDMA(MADC_ENABLE);
	/* Enable DMA */
	MDMA_DirectInitType dma = {MDMA_DISABLE, MDMA_DIRECTION_PER_MEM, MDMA_ENABLE,
								MDMA_DISABLE, MDMA_ENABLE, MDMA_PRIORITY_LOW, MDMA_CHANNEL_0};
	MDMA_TransferStruct dmat = {(u32*)DMAsrcAddr, (u32*)APP_u16IRData, 2, MDMA_SIZE_HWORD};
	MDMA_vDirectInit(DMA2, MDMA_STREAM_0, &dma);

	MDMA_vStart(DMA2, MDMA_STREAM_0, &dmat);

	MADC_vEnable(MADC_ENABLE, MADC_DISABLE);
}

int main(void)
{
	APP_vInit();
    /* Loop forever */
	for(;;) {}
}
